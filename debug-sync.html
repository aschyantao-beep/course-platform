<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®åŒæ­¥è°ƒè¯•å·¥å…·</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .status { color: #666; }
        .success { color: green; }
        .error { color: red; }
        button { padding: 8px 16px; margin: 5px; cursor: pointer; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ” Supabase æ•°æ®åŒæ­¥è°ƒè¯•å·¥å…·</h1>

    <div class="section">
        <h2>1. Supabase è¿æ¥çŠ¶æ€</h2>
        <div id="connection-status" class="status">æ£€æŸ¥ä¸­...</div>
        <button onclick="checkConnection()">é‡æ–°æ£€æŸ¥è¿æ¥</button>
    </div>

    <div class="section">
        <h2>2. ç”¨æˆ·è®¤è¯çŠ¶æ€</h2>
        <div id="auth-status" class="status">æ£€æŸ¥ä¸­...</div>
        <button onclick="checkAuth()">æ£€æŸ¥è®¤è¯çŠ¶æ€</button>
    </div>

    <div class="section">
        <h2>3. æœ¬åœ°å­˜å‚¨æ•°æ®</h2>
        <div id="local-data" class="status">æ£€æŸ¥ä¸­...</div>
        <button onclick="checkLocalData()">æ£€æŸ¥æœ¬åœ°æ•°æ®</button>
        <button onclick="clearLocalData()">æ¸…ç©ºæœ¬åœ°æ•°æ®</button>
    </div>

    <div class="section">
        <h2>4. Supabase æ•°æ®åº“è¡¨</h2>
        <div id="db-tables" class="status">æ£€æŸ¥ä¸­...</div>
        <button onclick="checkDatabaseTables()">æ£€æŸ¥æ•°æ®åº“è¡¨</button>
    </div>

    <div class="section">
        <h2>5. æ‰‹åŠ¨æ•°æ®åŒæ­¥</h2>
        <div id="sync-status" class="status">ç­‰å¾…æ“ä½œ...</div>
        <button onclick="manualSync()">æ‰‹åŠ¨åŒæ­¥æ•°æ®</button>
        <button onclick="testInsert()">æµ‹è¯•æ’å…¥æ•°æ®</button>
    </div>

    <div class="section">
        <h2>6. è¯¦ç»†æ—¥å¿—</h2>
        <pre id="detailed-log" style="height: 200px; overflow-y: scroll;">ç­‰å¾…æ—¥å¿—...\n</pre>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„è„šæœ¬ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
    <script>
        let supabase;
        let currentUser = null;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('detailed-log');
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
            logElement.textContent += `${timestamp} ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        async function checkConnection() {
            const statusDiv = document.getElementById('connection-status');
            try {
                await waitForSupabase();
                supabase = window.supabase;

                if (supabase) {
                    statusDiv.innerHTML = '<span class="success">âœ… Supabase å®¢æˆ·ç«¯å·²è¿æ¥</span>';
                    log('Supabase è¿æ¥æˆåŠŸ');

                    // æµ‹è¯•è¿æ¥
                    const { data, error } = await supabase.from('learning_sessions').select('count').single();
                    if (error && !error.message.includes('does not exist')) {
                        statusDiv.innerHTML += '<br><span class="error">âš ï¸ æ•°æ®åº“è®¿é—®é”™è¯¯: ' + error.message + '</span>';
                        log('æ•°æ®åº“è®¿é—®é”™è¯¯: ' + error.message, 'error');
                    } else {
                        log('æ•°æ®åº“è¿æ¥æµ‹è¯•æˆåŠŸ');
                    }
                } else {
                    statusDiv.innerHTML = '<span class="error">âŒ Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–</span>';
                    log('Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–', 'error');
                }
            } catch (error) {
                statusDiv.innerHTML = '<span class="error">âŒ è¿æ¥å¤±è´¥: ' + error.message + '</span>';
                log('è¿æ¥æ£€æŸ¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        function waitForSupabase() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50;

                const checkInterval = setInterval(() => {
                    attempts++;
                    if (window.supabaseClientInitialized) {
                        clearInterval(checkInterval);
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        reject(new Error('Supabase åˆå§‹åŒ–è¶…æ—¶'));
                    }
                }, 100);
            });
        }

        async function checkAuth() {
            const statusDiv = document.getElementById('auth-status');
            try {
                const { data: { session }, error } = await supabase.auth.getSession();

                if (error) {
                    statusDiv.innerHTML = '<span class="error">âŒ è·å–è®¤è¯çŠ¶æ€å¤±è´¥: ' + error.message + '</span>';
                    log('è®¤è¯çŠ¶æ€æ£€æŸ¥å¤±è´¥: ' + error.message, 'error');
                    return;
                }

                if (session && session.user) {
                    currentUser = session.user;
                    statusDiv.innerHTML = `<span class="success">âœ… ç”¨æˆ·å·²ç™»å½•: ${session.user.email}</span><br>ç”¨æˆ·ID: ${session.user.id}`;
                    log('ç”¨æˆ·å·²ç™»å½•: ' + session.user.email, 'success');
                } else {
                    statusDiv.innerHTML = '<span class="status">â„¹ï¸ ç”¨æˆ·æœªç™»å½•</span>';
                    log('ç”¨æˆ·æœªç™»å½•');
                }
            } catch (error) {
                statusDiv.innerHTML = '<span class="error">âŒ è®¤è¯æ£€æŸ¥å¤±è´¥: ' + error.message + '</span>';
                log('è®¤è¯æ£€æŸ¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        function checkLocalData() {
            const statusDiv = document.getElementById('local-data');

            try {
                const learningData = JSON.parse(localStorage.getItem('learningData') || '{}');
                const courseProgress = JSON.parse(localStorage.getItem('courseProgress') || '{}');
                const quizResults = JSON.parse(localStorage.getItem('quizResults') || '{}');

                let html = '<div><strong>å­¦ä¹ ä¼šè¯æ•°æ®:</strong></div>';
                html += `<pre>${JSON.stringify(learningData, null, 2)}</pre>`;

                html += '<div><strong>è¯¾ç¨‹è¿›åº¦æ•°æ®:</strong></div>';
                html += `<pre>${JSON.stringify(courseProgress, null, 2)}</pre>`;

                html += '<div><strong>æµ‹éªŒç»“æœæ•°æ®:</strong></div>';
                html += `<pre>${JSON.stringify(quizResults, null, 2)}</pre>`;

                statusDiv.innerHTML = html;

                // è®¡ç®—æ€»é‡
                const totalSessions = Object.values(learningData).reduce((sum, sessions) => sum + sessions.length, 0);
                const totalProgress = Object.keys(courseProgress).length;
                const totalQuizzes = Object.keys(quizResults).length;

                log(`æœ¬åœ°æ•°æ®ç»Ÿè®¡: ${totalSessions}ä¸ªå­¦ä¹ ä¼šè¯, ${totalProgress}ä¸ªè¯¾ç¨‹è¿›åº¦, ${totalQuizzes}ä¸ªæµ‹éªŒç»“æœ`);

            } catch (error) {
                statusDiv.innerHTML = '<span class="error">âŒ è¯»å–æœ¬åœ°æ•°æ®å¤±è´¥: ' + error.message + '</span>';
                log('è¯»å–æœ¬åœ°æ•°æ®å¤±è´¥: ' + error.message, 'error');
            }
        }

        function clearLocalData() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æœ¬åœ°å­¦ä¹ æ•°æ®å—ï¼Ÿ')) {
                localStorage.removeItem('learningData');
                localStorage.removeItem('courseProgress');
                localStorage.removeItem('quizResults');
                log('æœ¬åœ°æ•°æ®å·²æ¸…ç©º', 'success');
                checkLocalData();
            }
        }

        async function checkDatabaseTables() {
            const statusDiv = document.getElementById('db-tables');

            const tables = ['learning_sessions', 'user_progress', 'quiz_results'];
            let html = '';

            for (const tableName of tables) {
                try {
                    const { data, error } = await supabase.from(tableName).select('*').limit(1);

                    if (error) {
                        if (error.message.includes('does not exist')) {
                            html += `<div>âŒ è¡¨ "${tableName}" ä¸å­˜åœ¨</div>`;
                            log(`è¡¨ "${tableName}" ä¸å­˜åœ¨`, 'error');
                        } else {
                            html += `<div>âš ï¸ è¡¨ "${tableName}" è®¿é—®é”™è¯¯: ${error.message}</div>`;
                            log(`è¡¨ "${tableName}" è®¿é—®é”™è¯¯: ${error.message}`, 'error');
                        }
                    } else {
                        html += `<div>âœ… è¡¨ "${tableName}" å­˜åœ¨å¹¶å¯è®¿é—®</div>`;
                        log(`è¡¨ "${tableName}" å­˜åœ¨å¹¶å¯è®¿é—®`, 'success');
                    }
                } catch (error) {
                    html += `<div>âŒ æ£€æŸ¥è¡¨ "${tableName}" æ—¶å‡ºé”™: ${error.message}</div>`;
                    log(`æ£€æŸ¥è¡¨ "${tableName}" æ—¶å‡ºé”™: ${error.message}`, 'error');
                }
            }

            statusDiv.innerHTML = html;
        }

        async function manualSync() {
            const statusDiv = document.getElementById('sync-status');

            if (!currentUser) {
                statusDiv.innerHTML = '<span class="error">âŒ è¯·å…ˆç™»å½•</span>';
                log('è¯·å…ˆç™»å½•å†è¿›è¡Œæ•°æ®åŒæ­¥', 'error');
                return;
            }

            statusDiv.innerHTML = '<span class="status">ğŸ”„ æ­£åœ¨åŒæ­¥æ•°æ®...</span>';
            log('å¼€å§‹æ‰‹åŠ¨æ•°æ®åŒæ­¥');

            try {
                const learningData = JSON.parse(localStorage.getItem('learningData') || '{}');
                const courseProgress = JSON.parse(localStorage.getItem('courseProgress') || '{}');
                const quizResults = JSON.parse(localStorage.getItem('quizResults') || '{}');

                // åŒæ­¥å­¦ä¹ ä¼šè¯
                let syncedSessions = 0;
                Object.keys(learningData).forEach(date => {
                    learningData[date].forEach(session => {
                        // è¿™é‡Œåº”è¯¥è°ƒç”¨å®é™…çš„åŒæ­¥å‡½æ•°
                        syncedSessions++;
                    });
                });

                statusDiv.innerHTML = `<span class="success">âœ… åŒæ­¥å®Œæˆ: ${syncedSessions}ä¸ªä¼šè¯</span>`;
                log(`æ•°æ®åŒæ­¥å®Œæˆï¼ŒåŒæ­¥äº† ${syncedSessions} ä¸ªå­¦ä¹ ä¼šè¯`, 'success');

            } catch (error) {
                statusDiv.innerHTML = '<span class="error">âŒ åŒæ­¥å¤±è´¥: ' + error.message + '</span>';
                log('æ•°æ®åŒæ­¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function testInsert() {
            const statusDiv = document.getElementById('sync-status');

            if (!currentUser) {
                statusDiv.innerHTML = '<span class="error">âŒ è¯·å…ˆç™»å½•</span>';
                return;
            }

            try {
                const testData = {
                    user_id: currentUser.id,
                    course_id: 'test-course',
                    page_type: 'test',
                    start_time: new Date().toISOString(),
                    end_time: new Date().toISOString(),
                    duration: 60,
                    is_completed: true
                };

                const { data, error } = await supabase.from('learning_sessions').insert(testData);

                if (error) {
                    statusDiv.innerHTML = '<span class="error">âŒ æµ‹è¯•æ’å…¥å¤±è´¥: ' + error.message + '</span>';
                    log('æµ‹è¯•æ’å…¥å¤±è´¥: ' + error.message, 'error');
                } else {
                    statusDiv.innerHTML = '<span class="success">âœ… æµ‹è¯•æ’å…¥æˆåŠŸ</span>';
                    log('æµ‹è¯•æ’å…¥æˆåŠŸ', 'success');
                }
            } catch (error) {
                statusDiv.innerHTML = '<span class="error">âŒ æµ‹è¯•æ’å…¥å¼‚å¸¸: ' + error.message + '</span>';
                log('æµ‹è¯•æ’å…¥å¼‚å¸¸: ' + error.message, 'error');
            }
        }

        function clearLog() {
            document.getElementById('detailed-log').textContent = '';
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        document.addEventListener('DOMContentLoaded', function() {
            log('è°ƒè¯•å·¥å…·åŠ è½½å®Œæˆ');
            setTimeout(() => {
                checkConnection();
                checkAuth();
                checkLocalData();
            }, 1000);
        });
    </script>
</body>
</html>