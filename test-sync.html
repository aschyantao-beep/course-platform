<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®åŒæ­¥æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; border: 1px solid #007bff; background: #007bff; color: white; border-radius: 4px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; border-color: #6c757d; cursor: not-allowed; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px; height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; margin-top: 10px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 15px 0; }
        .stat-card { background: #f8f9fa; padding: 15px; border-radius: 5px; text-align: center; }
        .stat-number { font-size: 24px; font-weight: bold; color: #007bff; }
        .stat-label { font-size: 14px; color: #6c757d; margin-top: 5px; }
    </style>
</head>
<body>
    <h1>ğŸ”§ å­¦ä¹ æ•°æ®åŒæ­¥æµ‹è¯•å·¥å…·</h1>

    <div class="test-section">
        <h2>ğŸ“Š è¿æ¥ä¸è®¤è¯çŠ¶æ€</h2>
        <div id="connection-status" class="status info">æ£€æŸ¥ä¸­...</div>
        <button onclick="checkConnection()">æ£€æŸ¥è¿æ¥</button>
        <button onclick="checkAuth()">æ£€æŸ¥è®¤è¯çŠ¶æ€</button>
    </div>

    <div class="test-section">
        <h2>ğŸ“ˆ æœ¬åœ°æ•°æ®ç»Ÿè®¡</h2>
        <div class="stats" id="local-stats">
            <div class="stat-card">
                <div class="stat-number" id="local-sessions">0</div>
                <div class="stat-label">å­¦ä¹ ä¼šè¯</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="local-progress">0</div>
                <div class="stat-label">è¯¾ç¨‹è¿›åº¦</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="local-quizzes">0</div>
                <div class="stat-label">æµ‹éªŒç»“æœ</div>
            </div>
        </div>
        <button onclick="refreshLocalStats()">åˆ·æ–°æœ¬åœ°æ•°æ®</button>
        <button onclick="clearLocalData()">æ¸…ç©ºæœ¬åœ°æ•°æ®</button>
    </div>

    <div class="test-section">
        <h2>â˜ï¸ äº‘ç«¯æ•°æ®ç»Ÿè®¡</h2>
        <div class="stats" id="cloud-stats">
            <div class="stat-card">
                <div class="stat-number" id="cloud-sessions">-</div>
                <div class="stat-label">äº‘ç«¯ä¼šè¯</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="cloud-progress">-</div>
                <div class="stat-label">äº‘ç«¯è¿›åº¦</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="cloud-quizzes">-</div>
                <div class="stat-label">äº‘ç«¯æµ‹éªŒ</div>
            </div>
        </div>
        <button onclick="refreshCloudStats()" id="refresh-cloud-btn" disabled>åˆ·æ–°äº‘ç«¯æ•°æ®</button>
    </div>

    <div class="test-section">
        <h2>ğŸ”„ æ•°æ®åŒæ­¥æ“ä½œ</h2>
        <div id="sync-status" class="status info">ç­‰å¾…æ“ä½œ...</div>
        <button onclick="manualSyncAll()" id="sync-all-btn" disabled>æ‰‹åŠ¨åŒæ­¥æ‰€æœ‰æ•°æ®</button>
        <button onclick="testInsertSession()" id="test-session-btn" disabled>æµ‹è¯•æ’å…¥ä¼šè¯</button>
        <button onclick="testInsertProgress()" id="test-progress-btn" disabled>æµ‹è¯•æ’å…¥è¿›åº¦</button>
        <button onclick="simulateLearning()" id="simulate-btn" disabled>æ¨¡æ‹Ÿå­¦ä¹ è¿‡ç¨‹</button>
    </div>

    <div class="test-section">
        <h2>ğŸ“ æ“ä½œæ—¥å¿—</h2>
        <div id="log" class="log">ç­‰å¾…æ“ä½œ...\n</div>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„è„šæœ¬ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>

    <script>
        let supabase;
        let currentUser = null;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('log');
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            logElement.textContent += `${timestamp} ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        async function waitForSupabase() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50;

                const checkInterval = setInterval(() => {
                    attempts++;
                    if (window.supabaseClientInitialized) {
                        clearInterval(checkInterval);
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        reject(new Error('Supabase åˆå§‹åŒ–è¶…æ—¶'));
                    }
                }, 100);
            });
        }

        async function checkConnection() {
            const statusDiv = document.getElementById('connection-status');
            try {
                await waitForSupabase();
                supabase = window.supabase;

                if (supabase) {
                    statusDiv.className = 'status success';
                    statusDiv.textContent = 'âœ… Supabase å®¢æˆ·ç«¯å·²è¿æ¥';
                    log('Supabase è¿æ¥æˆåŠŸ', 'success');
                    return true;
                } else {
                    statusDiv.className = 'status error';
                    statusDiv.textContent = 'âŒ Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–';
                    log('Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–', 'error');
                    return false;
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = `âŒ è¿æ¥å¤±è´¥: ${error.message}`;
                log(`è¿æ¥æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                return false;
            }
        }

        async function checkAuth() {
            const statusDiv = document.getElementById('connection-status');
            try {
                const { data: { session }, error } = await supabase.auth.getSession();

                if (error) {
                    statusDiv.className = 'status error';
                    statusDiv.textContent = `âŒ è·å–è®¤è¯çŠ¶æ€å¤±è´¥: ${error.message}`;
                    log(`è®¤è¯çŠ¶æ€æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                    return false;
                }

                if (session && session.user) {
                    currentUser = session.user;
                    statusDiv.className = 'status success';
                    statusDiv.textContent = `âœ… ç”¨æˆ·å·²ç™»å½•: ${session.user.email}`;
                    log(`ç”¨æˆ·å·²ç™»å½•: ${session.user.email}`, 'success');

                    // å¯ç”¨éœ€è¦ç™»å½•çš„æŒ‰é’®
                    document.getElementById('refresh-cloud-btn').disabled = false;
                    document.getElementById('sync-all-btn').disabled = false;
                    document.getElementById('test-session-btn').disabled = false;
                    document.getElementById('test-progress-btn').disabled = false;
                    document.getElementById('simulate-btn').disabled = false;

                    return true;
                } else {
                    statusDiv.className = 'status info';
                    statusDiv.textContent = 'â„¹ï¸ ç”¨æˆ·æœªç™»å½• - è¯·å…ˆç™»å½•å†æµ‹è¯•æ•°æ®åŒæ­¥';
                    log('ç”¨æˆ·æœªç™»å½•ï¼Œéƒ¨åˆ†åŠŸèƒ½ä¸å¯ç”¨', 'warning');
                    return false;
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = `âŒ è®¤è¯æ£€æŸ¥å¤±è´¥: ${error.message}`;
                log(`è®¤è¯æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                return false;
            }
        }

        function refreshLocalStats() {
            try {
                const learningData = JSON.parse(localStorage.getItem('learningData') || '{}');
                const courseProgress = JSON.parse(localStorage.getItem('courseProgress') || '{}');
                const quizResults = JSON.parse(localStorage.getItem('quizResults') || '{}');

                const totalSessions = Object.values(learningData).reduce((sum, sessions) => sum + sessions.length, 0);
                const totalProgress = Object.keys(courseProgress).length;
                const totalQuizzes = Object.keys(quizResults).length;

                document.getElementById('local-sessions').textContent = totalSessions;
                document.getElementById('local-progress').textContent = totalProgress;
                document.getElementById('local-quizzes').textContent = totalQuizzes;

                log(`æœ¬åœ°æ•°æ®ç»Ÿè®¡: ${totalSessions}ä¸ªå­¦ä¹ ä¼šè¯, ${totalProgress}ä¸ªè¯¾ç¨‹è¿›åº¦, ${totalQuizzes}ä¸ªæµ‹éªŒç»“æœ`, 'info');

            } catch (error) {
                log(`è¯»å–æœ¬åœ°æ•°æ®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function refreshCloudStats() {
            if (!currentUser) {
                log('è¯·å…ˆç™»å½•', 'error');
                return;
            }

            try {
                // ç»Ÿè®¡å­¦ä¹ ä¼šè¯
                const { data: sessions, error: sessionsError } = await supabase
                    .from('learning_sessions')
                    .select('count')
                    .eq('user_id', currentUser.id);

                // ç»Ÿè®¡å­¦ä¹ è¿›åº¦
                const { data: progress, error: progressError } = await supabase
                    .from('user_progress')
                    .select('count')
                    .eq('user_id', currentUser.id);

                // ç»Ÿè®¡æµ‹éªŒç»“æœ
                const { data: quizzes, error: quizzesError } = await supabase
                    .from('quiz_results')
                    .select('count')
                    .eq('user_id', currentUser.id);

                if (sessionsError || progressError || quizzesError) {
                    throw new Error(sessionsError?.message || progressError?.message || quizzesError?.message);
                }

                document.getElementById('cloud-sessions').textContent = sessions[0]?.count || 0;
                document.getElementById('cloud-progress').textContent = progress[0]?.count || 0;
                document.getElementById('cloud-quizzes').textContent = quizzes[0]?.count || 0;

                log('äº‘ç«¯æ•°æ®ç»Ÿè®¡åˆ·æ–°æˆåŠŸ', 'success');

            } catch (error) {
                log(`åˆ·æ–°äº‘ç«¯æ•°æ®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function clearLocalData() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æœ¬åœ°å­¦ä¹ æ•°æ®å—ï¼Ÿ')) {
                localStorage.removeItem('learningData');
                localStorage.removeItem('courseProgress');
                localStorage.removeItem('quizResults');
                log('æœ¬åœ°æ•°æ®å·²æ¸…ç©º', 'success');
                refreshLocalStats();
            }
        }

        async function manualSyncAll() {
            if (!currentUser) {
                log('è¯·å…ˆç™»å½•', 'error');
                return;
            }

            const syncStatusDiv = document.getElementById('sync-status');
            syncStatusDiv.className = 'status info';
            syncStatusDiv.textContent = 'ğŸ”„ æ­£åœ¨åŒæ­¥æ•°æ®...';

            try {
                const learningData = JSON.parse(localStorage.getItem('learningData') || '{}');
                const courseProgress = JSON.parse(localStorage.getItem('courseProgress') || '{}');

                let syncedSessions = 0;
                let syncedProgress = 0;

                // åŒæ­¥å­¦ä¹ ä¼šè¯
                for (const [date, sessions] of Object.entries(learningData)) {
                    for (const session of sessions) {
                        const { error } = await supabase.from('learning_sessions').insert({
                            user_id: currentUser.id,
                            course_id: session.courseId || 'unknown',
                            page_type: session.pageInfo?.type || 'other',
                            start_time: new Date(session.startTime).toISOString(),
                            end_time: new Date(session.endTime).toISOString(),
                            duration: Math.round(session.duration / 1000),
                            is_completed: session.isComplete,
                            created_at: new Date(session.timestamp).toISOString()
                        });

                        if (!error) {
                            syncedSessions++;
                        }
                    }
                }

                // åŒæ­¥å­¦ä¹ è¿›åº¦
                for (const [courseId, progress] of Object.entries(courseProgress)) {
                    const { error } = await supabase.from('user_progress').upsert({
                        user_id: currentUser.id,
                        course_id: courseId,
                        lessons_completed: progress.lessonsCompleted || 0,
                        total_lessons: progress.totalLessons || 10,
                        progress_percentage: progress.progressPercentage || 0,
                        total_study_time: Math.round((progress.totalStudyTime || 0) / 1000),
                        session_count: progress.sessionCount || 0,
                        last_access_time: new Date(progress.lastAccessTime || Date.now()).toISOString()
                    }, {
                        onConflict: 'user_id,course_id'
                    });

                    if (!error) {
                        syncedProgress++;
                    }
                }

                syncStatusDiv.className = 'status success';
                syncStatusDiv.textContent = `âœ… åŒæ­¥å®Œæˆ: ${syncedSessions}ä¸ªä¼šè¯, ${syncedProgress}ä¸ªè¿›åº¦`;
                log(`æ•°æ®åŒæ­¥å®Œæˆ: ${syncedSessions}ä¸ªä¼šè¯, ${syncedProgress}ä¸ªè¿›åº¦`, 'success');

                // åˆ·æ–°ç»Ÿè®¡
                refreshLocalStats();
                refreshCloudStats();

            } catch (error) {
                syncStatusDiv.className = 'status error';
                syncStatusDiv.textContent = `âŒ åŒæ­¥å¤±è´¥: ${error.message}`;
                log(`æ•°æ®åŒæ­¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testInsertSession() {
            if (!currentUser) {
                log('è¯·å…ˆç™»å½•', 'error');
                return;
            }

            try {
                const testData = {
                    user_id: currentUser.id,
                    course_id: 'test-course-1',
                    page_type: 'course',
                    start_time: new Date(Date.now() - 60000).toISOString(),
                    end_time: new Date().toISOString(),
                    duration: 60,
                    is_completed: true
                };

                const { data, error } = await supabase.from('learning_sessions').insert(testData);

                if (error) {
                    throw error;
                }

                log('æµ‹è¯•å­¦ä¹ ä¼šè¯æ’å…¥æˆåŠŸ', 'success');
                refreshCloudStats();

            } catch (error) {
                log(`æµ‹è¯•æ’å…¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testInsertProgress() {
            if (!currentUser) {
                log('è¯·å…ˆç™»å½•', 'error');
                return;
            }

            try {
                const testData = {
                    user_id: currentUser.id,
                    course_id: 'test-course-1',
                    lessons_completed: 1,
                    total_lessons: 10,
                    progress_percentage: 10,
                    total_study_time: 60,
                    session_count: 1
                };

                const { data, error } = await supabase.from('user_progress').upsert(testData, {
                    onConflict: 'user_id,course_id'
                });

                if (error) {
                    throw error;
                }

                log('æµ‹è¯•å­¦ä¹ è¿›åº¦æ’å…¥æˆåŠŸ', 'success');
                refreshCloudStats();

            } catch (error) {
                log(`æµ‹è¯•æ’å…¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function simulateLearning() {
            if (!currentUser) {
                log('è¯·å…ˆç™»å½•', 'error');
                return;
            }

            const syncStatusDiv = document.getElementById('sync-status');
            syncStatusDiv.className = 'status info';
            syncStatusDiv.textContent = 'ğŸ¯ æ¨¡æ‹Ÿå­¦ä¹ è¿‡ç¨‹ä¸­...';

            try {
                log('å¼€å§‹æ¨¡æ‹Ÿå­¦ä¹ è¿‡ç¨‹', 'info');

                // æ¨¡æ‹Ÿå­¦ä¹ ä¼šè¯
                const sessionData = {
                    userId: currentUser.id,
                    pageInfo: { type: 'course', title: 'æµ‹è¯•è¯¾ç¨‹' },
                    courseId: 'test-course-simulate',
                    duration: 120000, // 2åˆ†é’Ÿ
                    startTime: Date.now() - 120000,
                    endTime: Date.now(),
                    isComplete: true,
                    timestamp: Date.now()
                };

                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                let learningData = JSON.parse(localStorage.getItem('learningData') || '{}');
                const today = new Date().toISOString().split('T')[0];
                if (!learningData[today]) {
                    learningData[today] = [];
                }
                learningData[today].push(sessionData);
                localStorage.setItem('learningData', JSON.stringify(learningData));

                // ç›´æ¥åŒæ­¥åˆ°äº‘ç«¯
                const { data: sessionResult, error: sessionError } = await supabase
                    .from('learning_sessions')
                    .insert({
                        user_id: currentUser.id,
                        course_id: sessionData.courseId,
                        page_type: sessionData.pageInfo.type,
                        start_time: new Date(sessionData.startTime).toISOString(),
                        end_time: new Date(sessionData.endTime).toISOString(),
                        duration: Math.round(sessionData.duration / 1000),
                        is_completed: sessionData.isComplete,
                        created_at: new Date(sessionData.timestamp).toISOString()
                    });

                if (sessionError) {
                    throw sessionError;
                }

                // æ¨¡æ‹Ÿå­¦ä¹ è¿›åº¦
                const progressData = {
                    courseId: sessionData.courseId,
                    totalStudyTime: sessionData.duration,
                    sessionCount: 1,
                    lastAccessTime: sessionData.timestamp,
                    lessonsCompleted: 1,
                    totalLessons: 10,
                    progressPercentage: 10
                };

                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                let courseProgress = JSON.parse(localStorage.getItem('courseProgress') || '{}');
                courseProgress[sessionData.courseId] = progressData;
                localStorage.setItem('courseProgress', JSON.stringify(courseProgress));

                // åŒæ­¥åˆ°äº‘ç«¯
                const { data: progressResult, error: progressError } = await supabase
                    .from('user_progress')
                    .upsert({
                        user_id: currentUser.id,
                        course_id: progressData.courseId,
                        lessons_completed: progressData.lessonsCompleted,
                        total_lessons: progressData.totalLessons,
                        progress_percentage: progressData.progressPercentage,
                        total_study_time: Math.round(progressData.totalStudyTime / 1000),
                        session_count: progressData.sessionCount,
                        last_access_time: new Date(progressData.lastAccessTime).toISOString()
                    }, {
                        onConflict: 'user_id,course_id'
                    });

                if (progressError) {
                    throw progressError;
                }

                syncStatusDiv.className = 'status success';
                syncStatusDiv.textContent = 'âœ… æ¨¡æ‹Ÿå­¦ä¹ å®Œæˆï¼Œæ•°æ®å·²åŒæ­¥';
                log('æ¨¡æ‹Ÿå­¦ä¹ å®Œæˆï¼Œå­¦ä¹ ä¼šè¯å’Œè¿›åº¦å·²åŒæ­¥åˆ°äº‘ç«¯', 'success');

                // åˆ·æ–°ç»Ÿè®¡
                refreshLocalStats();
                refreshCloudStats();

            } catch (error) {
                syncStatusDiv.className = 'status error';
                syncStatusDiv.textContent = `âŒ æ¨¡æ‹Ÿå­¦ä¹ å¤±è´¥: ${error.message}`;
                log(`æ¨¡æ‹Ÿå­¦ä¹ å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('æµ‹è¯•å·¥å…·åŠ è½½å®Œæˆ', 'success');

            setTimeout(async () => {
                const connected = await checkConnection();
                if (connected) {
                    await checkAuth();
                    refreshLocalStats();
                }
            }, 1000);
        });
    </script>
</body>
</html>